{"version":3,"file":"generate-dna-bundle.js","sourceRoot":"","sources":["../../src/processes/generate-dna-bundle.ts"],"names":[],"mappings":"AAIA,MAAM,CAAC,KAAK,UAAU,iBAAiB,CACrC,kBAAsC,EACtC,WAAwB,EACxB,IAAY,EACZ,UAAe;IAEf,oCAAoC;IACpC,MAAM,QAAQ,GAAG,WAAW,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,EAAC,QAAQ,EAAC,EAAE;QAExD,IAAI;YACF,OAAO,SAAS,CAAC,kBAAkB,EAAE,QAAQ,CAAC,aAAa,CAAC,CAAA;SAC7D;QAAC,OAAO,CAAC,EAAE;YACV,2EAA2E;YAC3E,2CAA2C;YAC3C,OAAO,SAAS,CAAA;SACjB;IACH,CAAC,CACF,CAAC;IACF,MAAM,UAAU,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAE/C,MAAM,KAAK,GAA0C,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAA0C,CAAC;IAE1H,wBAAwB;IACxB,MAAM,aAAa,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC;IACnE,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;IAE/C,MAAM,SAAS,GAAG,KAAK,CAAC,MAAM,CAC5B,CAAC,GAAG,EAAE,IAAI,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QACjB,GAAG,GAAG;QACN,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,UAAU,CAAC,IAAI,CAAC,CAAC;KAC1D,CAAC,EACF,EAAE,CACH,CAAC;IAEF,gBAAgB;IAChB,MAAM,SAAS,GAAc;QAC3B,QAAQ,EAAE;YACR,gBAAgB,EAAE,GAAG;YACrB,IAAI,EAAE,WAAW,CAAC,IAAI;YACtB,IAAI;YACJ,UAAU;YACV,KAAK,EAAE,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBACxB,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,IAAI;gBACvB,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,SAAS;gBAC5B,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,IAAI;aAC3B,CAAC,CAAQ;SACJ;QACR,SAAS;KACV,CAAC;IAEF,OAAO,SAAS,CAAC;AACnB,CAAC;AAED,KAAK,UAAU,SAAS,CACtB,kBAAsC,EACtC,WAAmB;IAEnB,MAAM,OAAO,GAAG,MAAM,kBAAkB,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;IAEjE,MAAM,IAAI,GAAG,MAAM,kBAAkB,CAAC,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;IACtE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;AAC3B,CAAC","sourcesContent":["import { CompositoryService } from '../services/compository-service';\nimport { DnaTemplate, ZomeDef } from '../types/dnas';\nimport { DnaBundle } from '@holochain/conductor-api';\n\nexport async function generateDnaBundle(\n  compositoryService: CompositoryService,\n  dnaTemplate: DnaTemplate,\n  uuid: string,\n  properties: any\n): Promise<DnaBundle> {\n  // Fetch all zomes for that template\n  const promises = dnaTemplate.zome_defs.map(async zome_def =>\n    {\n      try {\n        return fetchZome(compositoryService, zome_def.zome_def_hash)\n      } catch (e) {\n        // TODO: if we get an error, it means that the Files have not yet gossiped.\n        // Remove this when sharding is implemented\n        return undefined\n      }\n    }\n  );\n  const maybeZomes = await Promise.all(promises);\n\n  const zomes: Array<{zomeDef: ZomeDef, file: File}> = maybeZomes.filter(z => !!z) as Array<{zomeDef: ZomeDef, file: File}>;\n\n  // Prepare the arguments\n  const codesPromises = zomes.map((zome) => zome.file.arrayBuffer());\n  const codes = await Promise.all(codesPromises);\n\n  const resources = codes.reduce(\n    (acc, next, i) => ({\n      ...acc,\n      [zomes[i].zomeDef.name]: Array.from(new Uint8Array(next)),\n    }),\n    {}\n  );\n\n  // Create bundle\n  const dnaBundle: DnaBundle = {\n    manifest: {\n      manifest_version: '1',\n      name: dnaTemplate.name,\n      uuid,\n      properties,\n      zomes: zomes.map(zome => ({\n        name: zome.zomeDef.name,\n        hash: zome.zomeDef.wasm_hash,\n        bundled: zome.zomeDef.name,\n      })) as any,\n    } as any,\n    resources,\n  };\n\n  return dnaBundle;\n}\n\nasync function fetchZome(\n  compositoryService: CompositoryService,\n  zomeDefHash: string\n): Promise<{ zomeDef: ZomeDef; file: File }> {\n  const zomeDef = await compositoryService.getZomeDef(zomeDefHash);\n\n  const file = await compositoryService.downloadFile(zomeDef.wasm_file);\n  return { zomeDef, file };\n}\n"]}